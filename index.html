<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>野郞 BP APP</title>
<link rel="manifest" href="manifest.json">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  margin:0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont;
  background:#f3f4f6;
}

.app-badge {
  position: fixed;
  top: 10px;
  right: 12px;
  font-size: 11px;
  color: #6b7280;
  font-weight: 600;
  z-index: 999;
}

.container { padding:16px; }

.card {
  background:#fff;
  padding:12px;
  border-radius:12px;
  margin-bottom:12px;
  box-shadow:0 2px 6px rgba(0,0,0,.06);
}

input, button {
  width:100%;
  padding:8px;
  margin-top:6px;
  font-size:14px;
}

button {
  border:none;
  border-radius:8px;
  color:#fff;
  font-weight:600;
}

.btn-save { background:#ef4444; }
.btn-list { background:#3b82f6; }
.btn-chart { background:#8b5cf6; }
.btn-edit { background:#10b981; }
.btn-export { background:#6b7280; }

.view-toggle {
  display:flex;
  gap:8px;
  margin-bottom:10px;
}
.view-toggle button { flex:1; }

.high { color:#dc2626; font-weight:700; }
.warn { color:#f59e0b; font-weight:700; }
.normal { color:#16a34a; }

/* 수정 1: 리스트 5개 높이로 고정 및 스크롤 설정 */
#listWrapper {
  max-height: 180px; /* 항목당 36px * 5개 = 180px */
  overflow-y: auto;
  border-top: 1px solid #f0f0f0;
}

/* 수정 1 & 3: 항목 높이 고정 및 좌우 배치 설정 */
.record {
  display:flex;
  justify-content:space-between; /* 리스트는 왼쪽, 체크박스는 오른쪽 */
  align-items:center;
  height: 36px; /* 항목 높이 고정 */
  padding: 0 4px;
  border-bottom:1px solid #e5e7eb;
  font-size:14px;
  box-sizing: border-box;
}

/* 체크박스 크기 조절 */
.record input[type="checkbox"] {
  width: 18px;
  height: 18px;
  margin: 0;
  cursor: pointer;
}

.edit-hint {
  font-size:13px;
  color:#ef4444;
  margin-bottom:6px;
  font-weight:700;
}
</style>
</head>

<body>
<div class="app-badge">野郞 BP APP</div>

<div class="container">

<div class="card">
  <input type="date" id="date">
  <input id="sys" placeholder="최고혈압" type="number">
  <input id="dia" placeholder="최저혈압" type="number">
  <input id="note" placeholder="비고">
  <button class="btn-save" id="saveBtn">저장</button>
</div>

<div class="view-toggle">
  <button class="btn-list" id="listBtn">리스트</button>
  <button class="btn-chart" id="chartBtn">그래프</button>
</div>

<div class="card" id="summary"></div>

<div class="card" id="chartView" style="display:none;">
  <canvas id="chart"></canvas>
</div>

<div class="card" id="listView">
  <div id="editHint" class="edit-hint" style="display:none;">삭제할 데이터를 선택하세요</div>
  <div id="listWrapper"><div id="list"></div></div>
</div>

<div class="card">
  <button class="btn-edit" id="editBtn">편집</button>
  <button class="btn-export" id="exportBtn">CSV 내보내기</button>
</div>

</div>

<script>
const SYS_LIMIT = 140, DIA_LIMIT = 90;
let records = JSON.parse(localStorage.getItem('bp') || '[]');
let editMode = false;
let chart;

// 오늘 날짜 기본값 설정
date.value = new Date().toISOString().substring(0, 10);

saveBtn.onclick = () => {
  if (!date.value || !sys.value || !dia.value) return;
  records.push({ date:date.value, sys:+sys.value, dia:+dia.value, note:note.value });
  sys.value = dia.value = note.value = '';
  persist();
};

listBtn.onclick = () => { listView.style.display='block'; chartView.style.display='none'; };
chartBtn.onclick = () => { listView.style.display='none'; chartView.style.display='block'; chart?.update(); };

editBtn.onclick = () => {
  editMode = !editMode;
  editHint.style.display = editMode ? 'block' : 'none';
  render();
};

exportBtn.onclick = () => {
  let csv='날짜,최고혈압,최저혈압,비고\n';
  records.forEach(r=>csv+=`${r.date},${r.sys},${r.dia},${r.note||''}\n`);
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([csv], {type: 'text/csv;charset=utf-8;'}));
  a.download='blood_pressure.csv';
  a.click();
};

function persist(){ 
  // 날짜순 정렬 (최신이 위로)
  records.sort((a,b) => new Date(b.date) - new Date(a.date));
  localStorage.setItem('bp',JSON.stringify(records)); 
  render(); 
}

function level(r){
  if(r.sys>=SYS_LIMIT||r.dia>=DIA_LIMIT) return 'high';
  if(r.sys>=130||r.dia>=85) return 'warn';
  return 'normal';
}

function render(){
  list.innerHTML='';

  records.forEach((r,i)=>{
    const row=document.createElement('div');
    row.className=`record ${level(r)}`;

    const text=document.createElement('span');
    text.textContent=`${r.date} | ${r.sys}/${r.dia} | ${r.note||''}`;

    // 수정 3: 편집 모드 시 리스트 텍스트(왼쪽), 체크박스(오른쪽) 배치
    if(editMode){
      const chk=document.createElement('input');
      chk.type='checkbox';
      chk.onchange=()=>{
        if(confirm('이 기록을 삭제하시겠습니까?')){
          records.splice(i,1); persist();
        } else {
          chk.checked = false;
        }
      };
      row.appendChild(text); // 텍스트 먼저 (왼쪽)
      row.appendChild(chk);  // 체크박스 나중에 (오른쪽)
    } else {
      row.appendChild(text);
    }

    list.appendChild(row);
  });

  // 수정 2: 리스트 총 갯수 및 최근 30일 데이터 계산
  const thirtyDaysAgo = new Date();
  thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
  const recentCount = records.filter(r => new Date(r.date) >= thirtyDaysAgo).length;

  summary.innerHTML = `<strong>총 ${records.length}건</strong> · 최근 30일 <strong>${recentCount}건</strong>`;

  // 그래프 업데이트
  chart?.destroy();
  const chartRecords = [...records].reverse(); // 그래프는 시간순으로 표시
  chart = new Chart(document.getElementById('chart'),{
    type:'line',
    data:{
      labels:chartRecords.map(r=>r.date.substring(5)), // 월-일만 표시
      datasets:[
        {label:'최고', data:chartRecords.map(r=>r.sys), borderColor:'#ef4444', tension:0.2},
        {label:'최저', data:chartRecords.map(r=>r.dia), borderColor:'#3b82f6', tension:0.2}
      ]
    },
    options: { responsive: true, maintainAspectRatio: false }
  });
}

persist(); // 초기 로드 시 정렬 및 렌더링
</script>
</body>
</html>

