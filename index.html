<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>野郞 BPM APP - Pro</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  margin:0;
  font-family: 'Pretendard', system-ui, -apple-system, sans-serif;
  background:#f8fafc;
  color: #1e293b;
}

.header {
  background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
  color: white;
  padding: 12px 16px;
  text-align: center;
  border-radius: 0 0 16px 16px;
  box-shadow: 0 4px 8px rgba(30, 58, 138, 0.15);
  margin-bottom: 16px;
}

.header h1 { margin: 0; font-size: 19px; font-weight: 800; letter-spacing: -0.5px; }
.header p { margin: 2px 0 0; font-size: 11px; opacity: 0.85; }

.container { padding: 0 16px 40px; }

.card {
  background:#fff;
  padding:14px;
  border-radius:16px;
  margin-bottom:12px;
  box-shadow:0 2px 4px rgba(0,0,0,0.04);
}

input, button {
  width:100%;
  padding:10px;
  margin-top:8px;
  font-size:14px;
  border-radius:10px;
  border: 1px solid #e2e8f0;
  box-sizing: border-box;
}

button { border:none; color:#fff; font-weight:700; cursor: pointer; margin-top: 10px; }

.btn-save { background:#ef4444; margin-top: 14px; }
.btn-list { background:#3b82f6; }
.btn-chart { background:#8b5cf6; }
.btn-edit { background:#10b981; }
.btn-export { background:#64748b; flex: 1; }
.btn-import { background:#94a3b8; flex: 1; }

.view-toggle { display:flex; gap:10px; margin-bottom:12px; }
.view-toggle button { flex:1; margin-top:0; }

.status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; }
.dot-high { background: #ef4444; box-shadow: 0 0 5px #ef4444; }
.dot-warn { background: #f59e0b; }
.dot-normal { background: #10b981; }

#listWrapper { max-height: 250px; overflow-y: auto; }

.record {
  display: flex !important;
  justify-content: space-between !important;
  align-items: center;
  height: 44px;
  padding: 0 4px;
  border-bottom: 1px solid #f1f5f9;
  font-size: 14px;
}

.record-info { display: flex; align-items: center; flex: 1; }
.record-text { text-align: left; }

.record input[type="checkbox"] { width: 20px; height: 20px; margin-left: 12px; accent-color: #ef4444; }

.summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 12px; color: #64748b; text-align: center; }
.summary-val { font-size: 16px; font-weight: 800; color: #1e293b; display: block; }

.edit-hint { font-size:13px; color:#ef4444; margin-bottom:8px; font-weight:700; text-align: center; }
</style>
</head>

<body>

<div class="header">
  <h1>野郞 BPM APP</h1>
  <p>Blood Pressure Management System Pro</p>
</div>

<div class="container">

  <div class="card">
    <input type="date" id="date">
    <div style="display:flex; gap:8px;">
      <input id="sys" placeholder="최고(SYS)" type="number">
      <input id="dia" placeholder="최저(DIA)" type="number">
    </div>
    <input id="note" placeholder="메모 (선택사항)">
    <button class="btn-save" id="saveBtn">저장</button>
  </div>

  <div class="view-toggle">
    <button class="btn-list" id="listBtn">리스트</button>
    <button class="btn-chart" id="chartBtn">그래프</button>
  </div>

  <div class="card" id="summary">
    <div class="summary-grid">
      <div>최근 30일 평균<span class="summary-val" id="avgVal">0 / 0</span></div>
      <div>전체 기록<span class="summary-val" id="totalCount">0건</span></div>
    </div>
  </div>

  <div class="card" id="chartView" style="display:none;">
    <canvas id="chart" style="height:200px;"></canvas>
  </div>

  <div class="card" id="listView">
    <div id="editHint" class="edit-hint" style="display:none;">⚠️ 삭제할 항목의 체크박스를 눌러주세요</div>
    <div id="listWrapper">
      <div id="list"></div>
    </div>
  </div>

  <div style="margin-top: 10px;">
    <button class="btn-edit" id="editBtn">데이터 편집 모드</button>
    <div style="display:flex; gap:8px;">
      <button class="btn-export" id="exportBtn">CSV 내보내기</button>
      <button class="btn-import" id="importBtn">CSV 불러오기</button>
    </div>
    <input type="file" id="fileInput" accept=".csv" style="display:none;">
  </div>

</div>

<script>
const SYS_LIMIT = 140, DIA_LIMIT = 90;
let records = JSON.parse(localStorage.getItem('bp') || '[]');
let editMode = false;
let chart;

// 기본 날짜 설정
date.value = new Date().toISOString().substring(0, 10);

saveBtn.onclick = () => {
  if (!date.value || !sys.value || !dia.value) {
    alert("날짜와 수치를 모두 입력해주세요.");
    return;
  }
  
  // 데이터 추가
  records.push({ 
    date: date.value, 
    sys: parseInt(sys.value), 
    dia: parseInt(dia.value), 
    note: note.value 
  });
  
  // 입력창 초기화
  sys.value = dia.value = note.value = '';
  
  // 저장 및 렌더링
  persist();
  
  // 데이터 입력 후 자동으로 리스트 뷰로 전환하여 결과 확인
  listView.style.display='block';
  chartView.style.display='none';
};

listBtn.onclick = () => { listView.style.display='block'; chartView.style.display='none'; };
chartBtn.onclick = () => { 
  listView.style.display='none'; 
  chartView.style.display='block'; 
  renderChart(); 
};

editBtn.onclick = () => {
  editMode = !editMode;
  editBtn.innerText = editMode ? "편집 완료" : "데이터 편집 모드";
  editBtn.style.background = editMode ? "#334155" : "#10b981";
  editHint.style.display = editMode ? 'block' : 'none';
  render();
};

exportBtn.onclick = () => {
  if(records.length === 0) return alert('내보낼 데이터가 없습니다.');
  let csv='\ufeff날짜,최고혈압,최저혈압,메모\n';
  records.forEach(r=>csv+=`${r.date},${r.sys},${r.dia},${r.note||''}\n`);
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([csv], {type: 'text/csv;charset=utf-8;'}));
  a.download='BloodPressure_Data.csv';
  a.click();
};

importBtn.onclick = () => fileInput.click();

fileInput.onchange = (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (ev) => {
    const text = ev.target.result;
    const lines = text.split('\n');
    const newRecords = [];
    for(let i=1; i<lines.length; i++) {
      const cols = lines[i].split(',');
      if (cols.length >= 3) {
        newRecords.push({
          date: cols[0].replace('\ufeff', '').trim(),
          sys: parseInt(cols[1]),
          dia: parseInt(cols[2]),
          note: cols[3] ? cols[3].trim() : ""
        });
      }
    }
    if(confirm(`${newRecords.length}개의 데이터를 불러오시겠습니까?`)) {
      records = [...records, ...newRecords];
      persist();
    }
    fileInput.value = '';
  };
  reader.readAsText(file);
};

function persist(){ 
  // 날짜순 정렬 (최신순)
  records.sort((a,b) => new Date(b.date) - new Date(a.date));
  localStorage.setItem('bp', JSON.stringify(records)); 
  render(); 
}

function level(r){
  if(r.sys>=SYS_LIMIT||r.dia>=DIA_LIMIT) return 'dot-high';
  if(r.sys>=130||r.dia>=85) return 'dot-warn';
  return 'dot-normal';
}

function render(){
  const listEl = document.getElementById('list');
  listEl.innerHTML='';
  
  if(records.length === 0) {
    listEl.innerHTML = '<div style="text-align:center; padding:20px; color:#94a3b8; font-size:13px;">데이터가 없습니다.<br>새 기록을 추가해보세요.</div>';
  }

  records.forEach((r, i) => {
    const row = document.createElement('div');
    row.className = `record`;
    row.innerHTML = `
      <div class="record-info">
        <span class="status-dot ${level(r)}"></span>
        <div class="record-text">
          <strong>${r.date}</strong> | ${r.sys}/${r.dia} 
          <small style="color:#94a3b8">${r.note?'('+r.note+')':''}</small>
        </div>
      </div>
    `;

    if(editMode){
      const chk = document.createElement('input');
      chk.type = 'checkbox';
      chk.onclick = (e) => {
        setTimeout(() => {
          if(confirm('이 기록을 삭제하시겠습니까?')){
            records.splice(i, 1);
            persist();
          } else { e.target.checked = false; }
        }, 50);
      };
      row.appendChild(chk);
    }
    listEl.appendChild(row);
  });
  updateSummary();
}

function updateSummary() {
  const thirtyDaysAgo = new Date();
  thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
  const recentRecords = records.filter(r => new Date(r.date) >= thirtyDaysAgo);
  
  let avgSys = 0, avgDia = 0;
  if(recentRecords.length > 0) {
    avgSys = Math.round(recentRecords.reduce((s, r) => s + r.sys, 0) / recentRecords.length);
    avgDia = Math.round(recentRecords.reduce((s, r) => s + r.dia, 0) / recentRecords.length);
  }

  document.getElementById('avgVal').innerText = `${avgSys} / ${avgDia}`;
  document.getElementById('totalCount').innerText = `${records.length}건`;
}

function renderChart() {
  if (chart) chart.destroy();
  const ctx = document.getElementById('chart').getContext('2d');
  const chartRecords = [...records].slice(0, 15).reverse();
  chart = new Chart(ctx, {
    type:'line',
    data:{
      labels: chartRecords.map(r=>r.date.substring(5)),
      datasets:[
        { label:'최고', data:chartRecords.map(r=>r.sys), borderColor:'#ef4444', backgroundColor:'#ef4444', tension:0.3 },
        { label:'최저', data:chartRecords.map(r=>r.dia), borderColor:'#3b82f6', backgroundColor:'#3b82f6', tension:0.3 }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: { y: { beginAtZero: false } }
    }
  });
}
persist();
</script>
</body>
</html>
