<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>혈압 관리</title>
  <link rel="manifest" href="manifest.json">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: system-ui, sans-serif; background:#f3f4f6; padding:16px; }
    h1 { font-size:20px; margin-bottom:12px; }
    .card { background:white; padding:12px; border-radius:12px; margin-bottom:12px; box-shadow:0 2px 6px rgba(0,0,0,.06); }
    input, button { width:100%; padding:8px; margin-top:6px; }

    .btn-save { background:#ef4444; color:white; border:none; border-radius:8px; }
    .btn-list { background:#2563eb; color:white; border:none; border-radius:8px; }
    .btn-chart { background:#16a34a; color:white; border:none; border-radius:8px; }
    .btn-export { background:#7c3aed; color:white; border:none; border-radius:8px; }
    .btn-edit { background:#374151; color:white; border:none; border-radius:8px; }

    .high { color:#dc2626; font-weight:bold; }

    .view-toggle { display:flex; gap:8px; margin-bottom:10px; }
    .view-toggle button { flex:1; }

    .row { padding:6px; border-bottom:1px solid #e5e7eb; }
    .row.selectable { cursor:pointer; }
    .row.selected { background:#fee2e2; }
    .edit-hint { color:#dc2626; font-size:13px; margin-bottom:6px; }
  </style>
</head>
<body>

<h1>혈압 관리</h1>

<div class="card">
  <input type="date" id="date">
  <input id="sys" placeholder="최고혈압">
  <input id="dia" placeholder="최저혈압">
  <input id="note" placeholder="비고">
  <button class="btn-save" onclick="add()">저장</button>
</div>

<div class="view-toggle">
  <button class="btn-list" onclick="showList()">리스트 보기</button>
  <button class="btn-chart" onclick="showChart()">그래프 보기</button>
</div>

<div class="card" id="chartView" style="display:none;">
  <canvas id="chart"></canvas>
</div>

<div class="card" id="listView">
  <div id="editHint" class="edit-hint" style="display:none;">삭제할 데이터를 선택하세요</div>
  <div id="list"></div>
</div>

<div class="card">
  <button class="btn-export" onclick="exportCSV()">엑셀(CSV) 내보내기</button>
  <button class="btn-edit" onclick="toggleEdit()">편집</button>
</div>

<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js');
}

const dateInput = document.getElementById('date');
const sysInput = document.getElementById('sys');
const diaInput = document.getElementById('dia');
const noteInput = document.getElementById('note');
const listEl = document.getElementById('list');
const chartCanvas = document.getElementById('chart');
const editHint = document.getElementById('editHint');

const SYS_LIMIT = 140, DIA_LIMIT = 90;
let records = JSON.parse(localStorage.getItem('bp') || '[]');
let chart;
let editMode = false;

function save(){
  localStorage.setItem('bp', JSON.stringify(records));
  render();
}

function add(){
  if(!dateInput.value || !sysInput.value || !diaInput.value) return;

  records.push({
    date: dateInput.value,
    sys: +sysInput.value,
    dia: +diaInput.value,
    note: noteInput.value
  });

  dateInput.value = '';
  sysInput.value = '';
  diaInput.value = '';
  noteInput.value = '';

  save();
}

function toggleEdit(){
  editMode = !editMode;
  editHint.style.display = editMode ? 'block' : 'none';
  render();
}

function render(){
  listEl.innerHTML = '';

  records.forEach((r, index)=>{
    const row = document.createElement('div');
    row.className = 'row' + (editMode ? ' selectable' : '');

    if(r.sys >= SYS_LIMIT || r.dia >= DIA_LIMIT) row.classList.add('high');

    row.textContent = `${r.date}  ${r.sys}/${r.dia} ${r.note||''}`;

    if(editMode){
      row.onclick = () => {
        if(confirm('이 데이터를 삭제할까요?')){
          records.splice(index,1);
          save();
        }
      };
    }

    listEl.appendChild(row);
  });

  if(chart) chart.destroy();

  chart = new Chart(chartCanvas,{
    type:'line',
    data:{
      labels: records.map(r=>r.date),
      datasets:[
        {label:'최고혈압', data: records.map(r=>r.sys)},
        {label:'최저혈압', data: records.map(r=>r.dia)}
      ]
    }
  });
}

function showList(){
  document.getElementById('listView').style.display = 'block';
  document.getElementById('chartView').style.display = 'none';
}

function showChart(){
  document.getElementById('listView').style.display = 'none';
  document.getElementById('chartView').style.display = 'block';
  setTimeout(()=>{ if(chart) chart.update(); },50);
}

function exportCSV(){
  let csv='날짜,최고혈압,최저혈압,비고\n';
  records.forEach(r=>csv+=`${r.date},${r.sys},${r.dia},${r.note||''}\n`);
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([csv]));
  a.download='blood_pressure.csv';
  a.click();
}

render();
</script>

</body>
</html>
