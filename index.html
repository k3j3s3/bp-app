<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>野郞 BP APP</title>
<link rel="manifest" href="manifest.json">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  margin:0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont;
  background:#f3f4f6;
}

/* ===== 상단 앱바 ===== */
.appbar {
  background:#1e3a8a;
  color:#fff;
  padding:14px 16px;
  box-shadow:0 2px 6px rgba(0,0,0,.25);
}

.appbar-title {
  font-size:18px;
  font-weight:700;
}

.appbar-sub {
  font-size:12px;
  opacity:.85;
}

/* ===== 공통 ===== */
.container { padding:16px; }

.card {
  background:#fff;
  padding:12px;
  border-radius:12px;
  margin-bottom:12px;
  box-shadow:0 2px 6px rgba(0,0,0,.06);
}

input, button {
  width:100%;
  padding:8px;
  margin-top:6px;
  font-size:14px;
}

button {
  border:none;
  border-radius:8px;
  color:#fff;
  font-weight:600;
}

/* 버튼 색상 */
.btn-save { background:#ef4444; }
.btn-list { background:#3b82f6; }
.btn-chart { background:#8b5cf6; }
.btn-edit { background:#10b981; }
.btn-export { background:#6b7280; }

.view-toggle {
  display:flex;
  gap:8px;
  margin-bottom:10px;
}
.view-toggle button { flex:1; }

.high { color:#dc2626; font-weight:700; }

.record {
  display:flex;
  align-items:center;
  gap:6px;
  font-size:14px;
  margin-bottom:4px;
}

.record span { flex:1; }

.edit-hint {
  font-size:13px;
  color:#ef4444;
  margin-bottom:6px;
  font-weight:700;
}
</style>
</head>

<body>

<!-- 상단 앱바 -->
<div class="appbar">
  <div class="appbar-title">野郞 BP APP</div>
  <div class="appbar-sub">Blood Pressure Record</div>
</div>

<div class="container">

  <div class="card">
    <input type="date" id="date">
    <input id="sys" placeholder="최고혈압" type="number">
    <input id="dia" placeholder="최저혈압" type="number">
    <input id="note" placeholder="비고">
    <button class="btn-save" id="saveBtn">저장</button>
  </div>

  <div class="view-toggle">
    <button class="btn-list" id="listBtn">리스트 보기</button>
    <button class="btn-chart" id="chartBtn">그래프 보기</button>
  </div>

  <div class="card" id="chartView" style="display:none;">
    <canvas id="chart"></canvas>
  </div>

  <div class="card" id="listView">
    <div id="editHint" class="edit-hint" style="display:none;">
      삭제할 데이터를 선택하세요
    </div>
    <div id="list"></div>
  </div>

  <div class="card">
    <button class="btn-edit" id="editBtn">편집</button>
    <button class="btn-export" id="exportBtn">엑셀(CSV) 내보내기</button>
  </div>

</div>

<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js');
}

const SYS_LIMIT = 140, DIA_LIMIT = 90;
let records = JSON.parse(localStorage.getItem('bp') || '[]');
let chart;
let editMode = false;

const saveData = () => localStorage.setItem('bp', JSON.stringify(records));

saveBtn.onclick = () => {
  if (!date.value || !sys.value || !dia.value) return;
  records.push({ date:date.value, sys:+sys.value, dia:+dia.value, note:note.value });
  date.value = sys.value = dia.value = note.value = '';
  saveData();
  render();
};

listBtn.onclick = () => {
  listView.style.display='block';
  chartView.style.display='none';
};

chartBtn.onclick = () => {
  listView.style.display='none';
  chartView.style.display='block';
  chart?.update();
};

editBtn.onclick = () => {
  editMode = !editMode;
  editHint.style.display = editMode ? 'block' : 'none';
  render();
};

exportBtn.onclick = () => {
  let csv = '날짜,최고혈압,최저혈압,비고\n';
  records.forEach(r=>csv+=`${r.date},${r.sys},${r.dia},${r.note||''}\n`);
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([csv]));
  a.download='blood_pressure.csv';
  a.click();
};

function render() {
  list.innerHTML='';
  records.forEach((r,i)=>{
    const row=document.createElement('div');
    row.className='record'+((r.sys>=SYS_LIMIT||r.dia>=DIA_LIMIT)?' high':'');
    if(editMode){
      const c=document.createElement('input');
      c.type='checkbox';
      c.onchange=()=>confirm('삭제 할까요?')&&(records.splice(i,1),saveData(),render());
      row.appendChild(c);
    }
    const s=document.createElement('span');
    s.textContent=`${r.date}  ${r.sys}/${r.dia} ${r.note||''}`;
    row.appendChild(s);
    list.appendChild(row);
  });

  chart?.destroy();
  chart=new Chart(chart,{
    type:'line',
    data:{
      labels:records.map(r=>r.date),
      datasets:[
        {label:'최고혈압',data:records.map(r=>r.sys)},
        {label:'최저혈압',data:records.map(r=>r.dia)}
      ]
    }
  });
}

render();
</script>
</body>
</html>
